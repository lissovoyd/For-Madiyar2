<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Book Appointment</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <style>
    .custom-alert {
        background-color: #f3e8ff;
        color: #5a189a;
        border-left: 6px solid #764ba2;
        padding: 1rem 1.25rem;
        border-radius: 0.5rem;
        font-size: 1.05rem;
        }
        .custom-alert a {
        color: #5a189a;
        font-weight: 500;
        text-decoration: underline;
        }


    body { background: #f0f4f8; }
    .appt-card {
      max-width: 600px;
      margin: 4rem auto;
      padding: 2.5rem;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }
    h2 { font-size: 1.8rem; text-align: center; margin-bottom: 1.5rem; font-weight: 600; }
    label { font-weight: 500; }
    .btn-success { background-color: #764ba2; border: none; }
    .btn-success:hover { background-color: #667eea; }
  </style>
</head>
<body>
<div class="appt-card">
  <h2>üìÖ Book a Call with a Mentor</h2>

  {% if meeting_link %}
    <div class="custom-alert mt-4">
        ‚úÖ Appointment confirmed!<br>
        Meeting link: <a href="{{ meeting_link }}" target="_blank">{{ meeting_link }}</a>
    </div>
  {% else %}
    <form method="POST" id="booking-form">
      <div class="mb-3">
        <label for="mentor_id" class="form-label">Select Mentor:</label>
        <select id="mentor_id" name="mentor_id" class="form-select" required>
          <option value="">-- Choose --</option>
          {% for mentor in mentors %}
            <option value="{{ mentor.id }}">{{ mentor.name }} ‚Äî {{ mentor.bio_line1 }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label for="date" class="form-label">Choose a Date:</label>
        <input type="text" id="date" name="date" class="form-control" required disabled>
      </div>

      <div class="mb-3">
        <label for="time" class="form-label">Choose a Time:</label>
        <select id="time" name="time" class="form-select" required disabled>
          <option value="">-- Select Time --</option>
        </select>
      </div>

      <button type="submit" class="btn btn-success w-100">Confirm Booking</button>
    </form>
  {% endif %}

  <a href="{{ url_for('mentor_list') }}" class="btn btn-outline-secondary mt-4 w-100">‚Üê Back to Mentor List</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  const mentorData = {{ mentor_data | tojson | safe }};
  const TIME_CHOICES = {{ TIME_CHOICES | tojson | safe }};

  const mentorSelect = document.getElementById("mentor_id");
  const dateInput = document.getElementById("date");
  const timeSelect = document.getElementById("time");

  let flatpickrInstance;

  mentorSelect.addEventListener("change", () => {
    const selectedId = mentorSelect.value;
    if (!selectedId || !mentorData[selectedId]) {
      dateInput.disabled = true;
      timeSelect.disabled = true;
      return;
    }

    const mentor = mentorData[selectedId];

    // Enable date field with allowed days
    dateInput.disabled = false;
    if (flatpickrInstance) flatpickrInstance.destroy();
    flatpickrInstance = flatpickr(dateInput, {
      minDate: "today",
      dateFormat: "Y-m-d",
      disable: [
        function (date) {
          return !mentor.available_days.includes(date.getDay());
        }
      ]
    });

    // Populate available times
    timeSelect.innerHTML = `<option value="">-- Select Time --</option>`;
    mentor.available_times.forEach(idx => {
      const time = TIME_CHOICES[idx];
      const option = document.createElement("option");
      option.value = time;
      option.textContent = time;
      timeSelect.appendChild(option);
    });
    timeSelect.disabled = false;
  });
</script>
</body>
</html>
